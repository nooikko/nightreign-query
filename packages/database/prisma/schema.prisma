generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Boss {
  id                     String  @id @default(cuid())
  name                   String  @unique
  category               String
  location               String
  weaknesses             Json    // string[]
  phases                 Json    // BossPhase[]
  strategies             String
  rewards                String
  hpByPlayerCount        Json?   // {solo?, duo?, trio?}
  stance                 Int?
  parryInfo              Json?   // {canParry, parriesRequired?, notes?}
  damageNegation         Json?   // {phase1?, phase2?}
  statusResistances      Json?   // {poison?, scarletRot?, bloodLoss?, frostbite?, sleep?, madness?}
  strongerVs             Json?   // string[] - damage types boss is resistant to
  damageTypesDealt       Json?   // string[]
  statusEffectsInflicted Json?   // string[]
  attackPatterns         Json?   // BossAttackPatterns - {general?, phase1?, phase2?, phase3?}
  tags                   Json?   // string[]
  embedding              Bytes?
}

model Weapon {
  id                 String  @id @default(cuid())
  name               String  @unique
  type               String
  stats              Json
  statusBuildup      Json?   // WeaponStatusBuildup - bleed, frost, poison, etc.
  scaling            Json
  skill              String
  description        String
  passiveBenefits    Json?   // string[] - passive effects
  uniqueEffect       String? // Special weapon effect
  upgradeProgression Json?   // WeaponUpgradeProgression - 8 classes × 15 levels × 4 tiers
  tags               Json?   // string[] - for filtering
  embedding          Bytes?
}

model Relic {
  id           String  @id @default(cuid())
  name         String  @unique
  color        String
  tier         String
  effects      Json    // Array of effect strings stored as JSON
  classEffects Json?   // RelicClassEffect[] - character-specific effects per Nightfarer
  tags         Json?   // string[]
  embedding    Bytes?
}

model Nightfarer {
  id          String  @id @default(cuid())
  name        String  @unique
  stats       Json
  passive     String?
  skill       String?
  ultimate    String?
  vessel      String?
  progression Json?   // NightfarerProgression - HP/FP/Stamina per level 1-15
  tags        Json?   // string[]
  embedding   Bytes?
}

model Skill {
  id          String  @id @default(cuid())
  name        String  @unique
  fpCost      Int
  staminaCost Int?    // Stamina cost to use
  weaponTypes Json    // Array of weapon type strings stored as JSON
  effect      String
  location    String? // Where to obtain the skill
  tags        Json?   // string[]
  embedding   Bytes?
}

model Location {
  id                String  @id @default(cuid())
  name              String  @unique
  region            String
  description       String
  elementalAffinity String? // ElementalAffinity enum value (cold, fire, etc.)
  notableItems      Json    // string[]
  enemies           Json    // string[]
  bosses            Json    // string[]
  connections       Json    // string[]
  crystalTypes      Json?   // string[] - crystal types for loot tables
  favor             String? // Special location reward
  tags              Json    // string[]
  embedding         Bytes?
}

model Talisman {
  id        String  @id @default(cuid())
  name      String  @unique
  effect    String
  weight    Float?
  location  String
  tags      Json    // string[]
  embedding Bytes?
}

model Spell {
  id           String  @id @default(cuid())
  name         String  @unique
  spellType    String  // Sorcery or Incantation
  fpCost       Int
  slots        Int
  effect       String
  requirements String
  location     String
  tags         Json    // string[]
  embedding    Bytes?
}

model Armor {
  id              String  @id @default(cuid())
  name            String  @unique
  slot            String  // Head, Chest, Arms, Legs
  weight          Float?
  poise           Int?
  damageNegation  Json    // DamageNegation - {physical?, strike?, slash?, pierce?, magic?, fire?, lightning?, holy?}
  resistance      Json    // Resistance - {immunity?, robustness?, focus?, vitality?, poise?}
  location        String
  tags            Json    // string[]
  embedding       Bytes?
}

model Shield {
  id           String  @id @default(cuid())
  name         String  @unique
  shieldType   String  // Small, Medium, Greatshield
  weight       Float?
  guardBoost   Int?
  guard        Json?   // DamageNegation - blocking damage reduction per type
  skill        String
  requirements String
  location     String
  tags         Json    // string[]
  embedding    Bytes?
}

model Enemy {
  id         String  @id @default(cuid())
  name       String  @unique
  category   String
  locations  Json    // string[]
  weaknesses Json    // string[]
  drops      Json    // string[]
  hp         Int?    // Enemy HP
  runes      Int?    // Runes dropped on defeat
  strategies String
  tags       Json    // string[]
  embedding  Bytes?
}

model NPC {
  id        String  @id @default(cuid())
  name      String  @unique
  role      String
  location  String
  quests    Json    // string[]
  services  Json    // string[]
  tags      Json    // string[]
  embedding Bytes?
}

model Merchant {
  id           String  @id @default(cuid())
  name         String  @unique
  location     String
  inventory    Json    // MerchantItem[] - {name, price, currency}[]
  notableItems Json    // string[]
  tags         Json    // string[]
  embedding    Bytes?
}

model Expedition {
  id               String  @id @default(cuid())
  name             String  @unique
  difficulty       String
  recommendedLevel Int?
  objectives       Json    // string[]
  rewards          Json    // string[]
  locations        Json    // string[]
  strategies       String
  tags             Json    // string[]
  embedding        Bytes?
}

model Item {
  id                String  @id @default(cuid())
  name              String  @unique
  category          String  // Key Item, Consumable, Crafting Material, Upgrade Material, etc.
  effect            String  // What the item does
  description       String  // Flavor text/lore
  locations         Json    // string[] - where to find it
  purchaseLocations Json?   // ItemPurchaseInfo[] - {merchantName, location, price, stock?}[]
  uses              Int?    // Number of uses (null for unlimited/key items)
  tags              Json    // string[]
  embedding         Bytes?
}

model ContentChunk {
  id        String   @id @default(cuid())
  type      String
  name      String
  section   String
  content   String
  tags      Json     // Array of tag strings stored as JSON
  sourceUrl String?
  embedding Bytes?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================================
// FEEDBACK SYSTEM
// ============================================================================

/// A feedback session groups multiple feedback entries from a single game run
model FeedbackSession {
  id        String     @id @default(cuid())
  name      String?    // Optional name like "Night 3 Training Run"
  startedAt DateTime   @default(now())
  endedAt   DateTime?
  notes     String?    // Session-level notes
  feedback  Feedback[]

  @@index([startedAt])
}

/// Individual feedback on a search response
model Feedback {
  id          String           @id @default(cuid())
  sessionId   String?          // Optional session grouping
  session     FeedbackSession? @relation(fields: [sessionId], references: [id])

  // What was searched
  query       String           // The search query
  queryType   String?          // Filter type used (boss, weapon, etc.)

  // The response
  responseId  String?          // ID of specific result if rating individual result
  response    String           // The AI-formatted response or result content

  // Feedback
  helpful     Boolean          // true = thumbs up, false = thumbs down
  reason      String?          // Why it was/wasn't helpful
  expected    String?          // What the user expected to see

  // Metadata
  latencyMs   Int?             // Response time in milliseconds
  createdAt   DateTime         @default(now())

  @@index([sessionId])
  @@index([helpful, createdAt])
  @@index([query])
}
